<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1><i class="fas fa-shopping-cart me-2 text-primary"></i>Checkout</h1>
    <p class="text-muted mb-0">Review your order and select delivery address</p>
  </div>
  <div>
    <span class="badge bg-primary fs-6"><%= @cart_items.count %> items</span>
  </div>
</div>

<div class="row">
  <div class="col-md-8">
    <!-- Delivery Address Section -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Delivery Address</h5>
      </div>
      <div class="card-body">
        <% if @saved_addresses.any? %>
          <!-- Saved Addresses -->
          <div class="mb-4">
            <h6 class="mb-3">Choose from saved addresses:</h6>
            <div class="row">
              <% @saved_addresses.each_with_index do |address, index| %>
                <div class="col-md-6 mb-3">
                  <div class="card address-option h-100 <%= 'border-primary selected-address' if address.is_default? %>" 
                       data-address-id="<%= address.id %>"
                       data-address-text="<%= address.full_address %>"
                       style="cursor: pointer;">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-title mb-0">
                          <i class="fas fa-home me-2 text-primary"></i>
                          <%= address.name %>
                        </h6>
                        <% if address.is_default? %>
                          <span class="badge bg-primary">Default</span>
                        <% end %>
                      </div>
                      <p class="card-text small text-muted mb-2">
                        <%= address.address_line_1 %><br>
                        <% if address.address_line_2.present? %>
                          <%= address.address_line_2 %><br>
                        <% end %>
                        <%= address.city %>, <%= address.state %> <%= address.postal_code %><br>
                        <%= address.country %>
                      </p>
                      <div class="form-check">
                        <input class="form-check-input address-radio" 
                               type="radio" 
                               name="selected_address" 
                               id="address_<%= address.id %>" 
                               value="<%= address.id %>"
                               <%= 'checked' if address.is_default? %>>
                        <label class="form-check-label small text-success" for="address_<%= address.id %>">
                          <i class="fas fa-check-circle me-1"></i>Deliver to this address
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
          
          <!-- Add New Address Option -->
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="selected_address" id="new_address" value="new">
              <label class="form-check-label fw-bold" for="new_address">
                <i class="fas fa-plus-circle me-2 text-primary"></i>Add a new delivery address
              </label>
            </div>
          </div>
        <% else %>
          <!-- No Saved Addresses -->
          <div class="text-center py-4 mb-4">
            <i class="fas fa-map-marker-alt text-muted mb-3" style="font-size: 3rem; opacity: 0.3;"></i>
            <h6 class="text-muted">No saved addresses found</h6>
            <p class="text-muted small">Add your delivery address below</p>
          </div>
        <% end %>
        
        <!-- New Address Form (hidden by default if saved addresses exist) -->
        <div id="new-address-form" class="<%= 'collapse' if @saved_addresses.any? %>">
          <hr class="my-4">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h6 class="mb-0">
                <i class="fas fa-plus me-2"></i>Add New Delivery Address
              </h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="new_address_name" class="form-label">Address Name</label>
                  <input type="text" class="form-control" id="new_address_name" placeholder="e.g., Home, Office, Mom's House">
                  <div class="form-text">Give this address a memorable name</div>
                </div>
                <div class="col-md-12 mb-3">
                  <label for="new_address_line_1" class="form-label">Address Line 1</label>
                  <input type="text" class="form-control" id="new_address_line_1" placeholder="Street address" required>
                </div>
                <div class="col-md-12 mb-3">
                  <label for="new_address_line_2" class="form-label">Address Line 2 (Optional)</label>
                  <input type="text" class="form-control" id="new_address_line_2" placeholder="Apartment, suite, etc.">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="new_address_city" class="form-label">City</label>
                  <input type="text" class="form-control" id="new_address_city" placeholder="City" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="new_address_state" class="form-label">State</label>
                  <input type="text" class="form-control" id="new_address_state" placeholder="State/Province" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="new_address_postal_code" class="form-label">Postal Code</label>
                  <input type="text" class="form-control" id="new_address_postal_code" placeholder="ZIP/Postal Code" required>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="new_address_country" class="form-label">Country</label>
                  <input type="text" class="form-control" id="new_address_country" placeholder="Country" value="India" required>
                </div>
                <div class="col-md-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="save_address" checked>
                    <label class="form-check-label" for="save_address">
                      Save this address for future orders
                    </label>
                    <div class="form-text">This will be saved to your address book for faster checkout</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Order Form -->
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Contact Information</h5>
      </div>
      <div class="card-body">
        <%= form_with model: @order, local: true, id: "checkout-form" do |form| %>
          <% if @order.errors.any? %>
            <div class="alert alert-danger">
              <ul class="mb-0">
                <% @order.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <!-- Hidden fields for address -->
          <%= form.hidden_field :address, id: "order_address" %>
          <%= hidden_field_tag :selected_address_id, "", id: "selected_address_id" %>
          <%= hidden_field_tag :save_new_address, "false", id: "save_new_address" %>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <%= form.label :name, class: "form-label" %>
              <%= form.text_field :name, class: "form-control", value: current_user.name, required: true %>
            </div>
            <div class="col-md-6 mb-3">
              <%= form.label :email, class: "form-label" %>
              <%= form.email_field :email, class: "form-control", value: current_user.email, required: true %>
            </div>
          </div>
          
          <!-- Selected Address Display -->
          <div id="selected-address-display" class="alert alert-info" style="display: none;">
            <h6><i class="fas fa-map-marker-alt me-2"></i>Delivery Address:</h6>
            <p id="selected-address-text" class="mb-0"></p>
          </div>
          
          <div class="d-flex justify-content-between align-items-center mt-4">
            <%= link_to cart_path, class: "btn btn-outline-secondary" do %>
              <i class="fas fa-arrow-left me-2"></i>Back to Cart
            <% end %>
            <%= form.submit "Place Order", class: "btn btn-success btn-lg", id: "place-order-btn" do %>
              <i class="fas fa-credit-card me-2"></i>Place Order
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h5>Order Summary</h5>
      </div>
      <div class="card-body">
        <% @cart_items.each do |item| %>
          <div class="d-flex justify-content-between mb-2">
            <span><%= item[:product].name %> Ã— <%= item[:quantity] %></span>
            <span>$<%= sprintf("%.2f", item[:subtotal]) %></span>
          </div>
        <% end %>
        <hr>
        <div class="d-flex justify-content-between">
          <strong>Total: $<%= sprintf("%.2f", @total) %></strong>
        </div>
        
        <div class="mt-3">
          <small class="text-muted">
            <i class="fas fa-info-circle"></i>
            This is a demo checkout. No real payment will be processed.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Checkout Address Form Styling */
.address-option {
  transition: all 0.3s ease;
  cursor: pointer;
  border: 2px solid #e9ecef;
}

.address-option:hover {
  border-color: #007bff;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
}

.address-option.selected-address {
  border-color: #007bff !important;
  background-color: rgba(0, 123, 255, 0.05);
}

.address-option .form-check-input:checked {
  background-color: #28a745;
  border-color: #28a745;
}

.address-option .card-title {
  color: #495057;
  font-weight: 600;
}

.address-option:hover .card-title {
  color: #007bff;
}

/* New Address Form Styling */
#new-address-form {
  transition: all 0.4s ease;
}

#new-address-form.collapse:not(.show) {
  display: none;
}

#new-address-form.collapsing {
  height: 0;
  overflow: hidden;
  transition: height 0.4s ease;
}

#new-address-form.collapse.show {
  display: block;
}

#new-address-form .card {
  animation: slideInUp 0.4s ease-out;
  border: 2px solid #007bff;
  box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#new-address-form .card-header {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

#new-address-form .form-control {
  border-radius: 6px;
  transition: all 0.3s ease;
}

#new-address-form .form-control:focus {
  border-color: #007bff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  transform: translateY(-1px);
}

#new-address-form .form-control.is-invalid {
  border-color: #dc3545;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

#new-address-form .form-text {
  color: #6c757d;
  font-size: 0.875rem;
}

/* Selected Address Display */
#selected-address-display {
  border-left: 4px solid #007bff;
  background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0.05) 100%);
  animation: fadeInDown 0.3s ease-out;
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Form Validation Styling */
.is-invalid {
  border-color: #dc3545 !important;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.is-valid {
  border-color: #28a745 !important;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
}

/* Radio Button Enhancement */
.form-check-input[type="radio"] {
  transition: all 0.2s ease;
}

.form-check-input[type="radio"]:checked {
  background-color: #007bff;
  border-color: #007bff;
  transform: scale(1.1);
}

.form-check-label {
  transition: color 0.2s ease;
  cursor: pointer;
}

.form-check-input[type="radio"]:checked + .form-check-label {
  color: #007bff;
  font-weight: 600;
}

/* Checkout Button Enhancement */
#place-order-btn {
  font-weight: 600;
  padding: 0.75rem 2rem;
  border-radius: 8px;
  transition: all 0.3s ease;
}

#place-order-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

#place-order-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .address-option {
    margin-bottom: 1rem;
  }
  
  #new-address-form .card-body {
    padding: 1rem;
  }
  
  .address-option:hover {
    transform: none;
  }
}
</style>
